---
- name: "Search-only, return list of found updates (if any), log to {{ check_win_updates_log_path }}"
  win_updates:
    category_names: "{{ win_update_category }}"
    state: searched
    log_path: "{{ check_win_updates_log_path }}"
  register: list_of_updates

- name: Create Reports Directory
  file:
    path: /tmp/reports
    state: directory
    mode: 0755
  delegate_to: localhost

- name: Template Rendering
  template:
    src: win_updates_report.j2
    dest: "/tmp/reports_{{ inventory_hostname }}"
  loop: "{{ list_of_updates.updates | dict2items }}"
  delegate_to: localhost

#- name: List Remaining Updates
#  debug:
#    msg: "{{ item.value.title }}"
#  loop: "{{ list_of_updates.updates | dict2items }}"
#
#- name: Flag if Required Update is not installed. Skip if required update has been installed.
#  debug:
#    msg: "KB{{ item.value.title }} is not installed!"
#  loop: "{{ list_of_updates.updates | dict2items }}"
#  vars:
#    required_win_update: "{{ win_update_whitelist }}"
#  when: item.value.kb == required_win_update
#
#- name: Send Email
#  mail:
#    host: smtp.gmail.com
#    port: 587
#    username: "{{ gmail_account }}"
#    password: "{{ gmail_account_password }}"
#    to: Anthony Lin <anthony.lin.test@gmail.com>
#    subject: "Ansible Report"
#    body: "{{ item.value.title }}"
#  loop: "{{ list_of_updates.updates | dict2items }}"
#  delegate_to: localhost
